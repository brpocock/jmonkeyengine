<h1><a
name="seamonkey_-_jme3_water_system">SeaMonkey - jME3 Water System</a></h1><div
class="level1"><p> <strong>DRAFT</strong></p><p> Here is some background info for JME3&#039;s frist water implementation, nicknamed SeaMonkey:</p><ul><li
class="level1"><div
class="li"> <a
href="http://www.jmonkeyengine.com/forum/index.php?topic=14740.0">http://www.jmonkeyengine.com/forum/index.php?topic=14740.0</a></div></li><li
class="level1"><div
class="li"> <a
href="http://www.bonzaisoftware.com/water_tut.html">http://www.bonzaisoftware.com/water_tut.html</a></div></li><li
class="level1"><div
class="li"> <a
href="http://www.gametutorials.com/Articles/RealisticWater.pdf">http://www.gametutorials.com/Articles/RealisticWater.pdf</a></div></li></ul><p> <a
href="/wiki/lib/exe/fetch.php?hash=af543c&amp;media=http%3A%2F%2Fwww.jmonkeyengine.com%2Fwp-content%2Fuploads%2F2010%2F10%2Fsimplewaterdemo.jpg"><img
src="/wiki/lib/exe/fetch.php?hash=af543c&amp;w=277&amp;h=180&amp;media=http%3A%2F%2Fwww.jmonkeyengine.com%2Fwp-content%2Fuploads%2F2010%2F10%2Fsimplewaterdemo.jpg" class="mediacenter" title="www.jmonkeyengine.com_wp-content_uploads_2010_10_simplewaterdemo.jpg" alt="www.jmonkeyengine.com_wp-content_uploads_2010_10_simplewaterdemo.jpg" width="277" height="180" /></a></p></div><h2><a
name="simplewaterprocessor">SimpleWaterProcessor</a></h2><div
class="level2"><p> A JME3 scene with water uses a <code>com.jme3.water.SimpleWaterProcessor</code> (which implements the SceneProcessor interface).</p><p> To achieve a water effect, JME3 uses shaders and a special material, <code>Common/MatDefs/Water/SimpleWater.j3md</code>. The water surface is a quad, and we use normal map and dU/dV map texturing to simulate the waves.</p><ol><li
class="level1"><div
class="li"> Every frame, we render to three texture maps:</div><ul><li
class="level2"><div
class="li"> For the water surface (reflection), we take a snapshot of the environment, flip it upside down, and clip it to the visible water surface. Note that we do not actually use a &quot;water texture&quot; color map: The &quot;texture&quot; of the water is solely a distorted reflection.</div></li><li
class="level2"><div
class="li"> For the &quot;wavy&quot; distortion (refraction), we use the derivative of a normal map, a dU/dV map.</div></li><li
class="level2"><div
class="li"> For the fogginess of water (depth) we use a depth map from the terrains z-buffer.</div></li></ul></li><li
class="level1"><div
class="li"> In the shaders, we add all of the texture maps together.</div><ul><li
class="level2"><div
class="li"> For the &quot;bumpy&quot; displacement of the waves, we use a normal map and a du/dv map that are shifted against each other over time to create the wave effect.</div></li><li
class="level2"><div
class="li"> For the light reflection vectors on the water surface, we use the Fresnel formula, together with normal vectors.</div></li><li
class="level2"><div
class="li"> We add specular lighting.</div></li></ul></li><li
class="level1"><div
class="li"> (For the underwater caustics effect, we use splatted textures. – TODO)</div></li></ol></div><h2><a
name="usage">Usage</a></h2><div
class="level2"><p> <a
href="/wiki/lib/exe/detail.php/jme3:advanced:simplewater.png?id=jme3%3Aadvanced%3Awater"><img
src="nbdocs:/com/jme3/gde/core/docs/jme3/advanced/simplewater.png?w=384&amp;h=288" class="mediaright" align="right" alt="" width="384" height="288" /></a></p><ol><li
class="level1"><div
class="li"> Create a <code>mainScene</code> Node</div><ol><li
class="level2"><div
class="li"> Attach the <code>mainScene</code> Node to the <code>rootNode</code></div></li></ol></li><li
class="level1"><div
class="li"> Load your <code>scene</code> Spatial</div><ol><li
class="level2"><div
class="li"> Add a light source to the <code>scene</code> Spatial</div></li><li
class="level2"><div
class="li"> Attach the <code>scene</code> Spatial to the <code>mainScene</code> Node</div></li></ol></li><li
class="level1"><div
class="li"> Load your <a
href="/com/jme3/gde/core/docs/jme3/advanced/sky.html">sky</a> Geometry</div><ol><li
class="level2"><div
class="li"> Attach the sky Geometry to the <code>mainScene</code> Node</div></li></ol></li><li
class="level1"><div
class="li"> Create the SimpleWaterProcessor <code>waterProcessor</code></div><ol><li
class="level2"><div
class="li"> Set the processor&#039;s ReflectionScene to the <code>mainScene</code> Spatial (!)</div></li><li
class="level2"><div
class="li"> Set the processor&#039;s Plane to where you want your water surface to be</div></li><li
class="level2"><div
class="li"> Set the processor&#039;s WaterDepth, DistortionScale, and WaveSpeed</div></li><li
class="level2"><div
class="li"> Attach the processor to the <code>viewPort</code></div></li></ol></li><li
class="level1"><div
class="li"> Create a Quad <code>quad</code></div><ol><li
class="level2"><div
class="li"> Set the quad&#039;s TextureCoordinates to specify the size of the waves</div></li></ol></li><li
class="level1"><div
class="li"> Create a <code>water</code> Geometry from the Quad</div><ol><li
class="level2"><div
class="li"> Set the water&#039;s translation and rotation (same Y value as Plane above!)</div></li><li
class="level2"><div
class="li"> Set the water&#039;s material to the processor&#039;s output material</div></li><li
class="level2"><div
class="li"> Attach the <code>water</code> Geometry to the <code>rootNode</code>. (Not to the mainScene!)</div></li></ol></li></ol></div><h2><a
name="sample_code">Sample Code</a></h2><div
class="level2"><p> The sample code can be found in <code>jme3/src/jme3test/water/TestSimpleWater.java</code> and <code>jme3/src/jme3test/water/TestSceneWater.java</code>.</p><p> Here is the most important part of the code:</p><pre>// we create a water processor
SimpleWaterProcessor waterProcessor = new SimpleWaterProcessor&#40;assetManager&#41;;
waterProcessor.setReflectionScene&#40;mainScene&#41;;
&nbsp;
// we set the water plane
Vector3f waterLocation=new Vector3f&#40;0,-6,0&#41;;
waterProcessor.setPlane&#40;new Plane&#40;Vector3f.UNIT_Y, waterLocation.dot&#40;Vector3f.UNIT_Y&#41;&#41;&#41;;
viewPort.addProcessor&#40;waterProcessor&#41;;
&nbsp;
// we set wave properties
waterProcessor.setWaterDepth&#40;40&#41;;         // transparency of water
waterProcessor.setDistortionScale&#40;0.05f&#41;; // strength of waves
waterProcessor.setWaveSpeed&#40;0.05f&#41;;       // speed of waves
&nbsp;
// we define the wave size by setting the size of the texture coordinates
Quad quad = new Quad&#40;400,400&#41;;
quad.scaleTextureCoordinates&#40;new Vector2f&#40;6f,6f&#41;&#41;;
&nbsp;
// we create the water geometry from the quad
Geometry water=new Geometry&#40;&quot;water&quot;, quad&#41;;
water.setLocalRotation&#40;new Quaternion&#40;&#41;.fromAngleAxis&#40;-FastMath.HALF_PI, Vector3f.UNIT_X&#41;&#41;;
water.setLocalTranslation&#40;-200, -6, 250&#41;;
water.setShadowMode&#40;ShadowMode.Receive&#41;;
water.setMaterial&#40;waterProcessor.getMaterial&#40;&#41;&#41;;
rootNode.attachChild&#40;water&#41;;</pre></div><h2><a
name="settings">Settings</a></h2><div
class="level2"><p> You can lower the render size to gain higher performance:</p><pre>waterProcessor.setRenderSize&#40;128,128&#41;;</pre><p> The deeper the water, the more transparent. (?)</p><pre>waterProcessor.setWaterDepth&#40;40&#41;;</pre><p> A higher distortion scale makes bigger waves.</p><pre>waterProcessor.setDistortionScale&#40;0.05f&#41;;</pre><p> A lower wave speed makes calmer water.</p><pre>waterProcessor.setWaveSpeed&#40;0.05f&#41;;</pre><p> If your scene does not have a lightsource, you can set the light direction for the water:</p><pre>waterProcessor.setLightDirection&#40; new Vector3f&#40;0.55f, -0.82f, 0.15f&#41;&#41;;</pre><p> Instead of creating a quad and specifying a plane, you can get a default waterplane from the processor:</p><pre>Geometry waterPlane = waterProcessor.createWaterGeometry&#40;10, 10&#41;;
waterPlane.setLocalTranslation&#40;-5, 0, 5&#41;;
waterPlane.setMaterial&#40;waterProcessor.getMaterial&#40;&#41;&#41;;</pre><p> You can offer a switch to set the water Material to a static texture – for users with slow PCs.</p></div>
<p><em><a href="http://jmonkeyengine.org/wiki/doku.php/jme3:advanced:water?do=export_xhtmlbody">view online version</a></em></p>